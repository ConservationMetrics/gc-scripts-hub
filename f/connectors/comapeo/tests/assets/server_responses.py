SAMPLE_OBSERVATIONS = [
    {
        "docId": "doc_id_1",
        "versionId": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6/0",
        "originalVersionId": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6/0",
        "schemaName": "observation",
        "createdAt": "2024-10-14T20:18:14.206Z",
        "updatedAt": "2024-10-14T20:18:14.206Z",
        "links": [],
        "deleted": False,
        "attachments": [
            {
                "url": "http://comapeo.example.org/projects/forest_expedition/attachments/d40591d48d01318d3e6d0af02aa07b6b8ba4f31acbecca4e1c921468bc1fe6e4/photo/07d7a57058e554b6"
            },
            {
                "url": "http://comapeo.example.org/projects/forest_expedition/attachments/d40591d48d01318d3e6d0af02aa07b6b8ba4f31acbecca4e1c921468bc1fe6e4/audio/4f8074a2f9c161c6"
            },
        ],
        "tags": {
            "notes": "Rapid",
            "type": "water",
            "status": "active",
            "created_at": "village",
        },
        "lat": -33.8688,
        "lon": 151.2093,
        "metadata": {
            "manualLocation": False,
            "position": {
                "timestamp": "2024-10-14T20:18:10.658Z",
                "coords": {
                    "latitude": -33.8688,
                    "longitude": 151.2093,
                    "altitude": 39.29999923706055,
                    "altitudeAccuracy": 0.6382266283035278,
                    "heading": 0,
                    "speed": 0.013057432137429714,
                    "accuracy": 3.7899999618530273,
                },
                "mocked": False,
            },
        },
        "presetRef": {
            "docId": "e8438f39d2130f478d72c933a6b30dd564075a57c0a0abcf48fd3dc47b4beb24",
            "versionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/279",
            "url": "http://comapeo.example.org/projects/forest_expedition/preset/e8438f39d2130f478d72c933a6b30dd564075a57c0a0abcf48fd3dc47b4beb24",
        },
    },
    {
        "docId": "doc_id_2",
        "versionId": "b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7/1",
        "originalVersionId": "b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7/1",
        "schemaName": "observation",
        "createdAt": "2024-10-15T21:19:15.207Z",
        "updatedAt": "2024-10-15T21:19:15.207Z",
        "links": [],
        "deleted": False,
        "attachments": [
            {
                "url": "http://comapeo.example.org/projects/forest_expedition/attachments/d40591d48d01318d3e6d0af02aa07b6b8ba4f31acbecca4e1c921468bc1fe6e4/photo/capybara.jpg"
            }
        ],
        "tags": {
            "notes": "Capybara",
            "type": "animal",
            "animal-type": "capybara",
        },
        "lat": 48.8566,
        "lon": 2.3522,
        "metadata": {
            "manualLocation": False,
            "position": {
                "timestamp": "2024-10-15T21:19:10.658Z",
                "coords": {
                    "latitude": 48.8566,
                    "longitude": 2.3522,
                    "altitude": 40.19999923706055,
                    "altitudeAccuracy": 0.6009225845336914,
                    "heading": 0,
                    "speed": 0.011960787698626518,
                    "accuracy": 3.7899999618530273,
                },
                "mocked": False,
            },
        },
        "presetRef": {
            "docId": "1a08db5f19640fcd22016c35e45aa04f07a3f1a8dc1293dff9fd9232fd5b9c10",
            "versionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/281",
            "url": "http://comapeo.example.org/projects/forest_expedition/preset/1a08db5f19640fcd22016c35e45aa04f07a3f1a8dc1293dff9fd9232fd5b9c10",
        },
    },
    {
        "docId": "doc_id_3",
        "versionId": "c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8/2",
        "originalVersionId": "c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8/2",
        "schemaName": "observation",
        "createdAt": "2024-10-16T22:20:16.208Z",
        "updatedAt": "2024-10-16T22:20:16.208Z",
        "links": [],
        "deleted": False,
        "attachments": [],
        "tags": {
            "notes": "Former village site",
            "type": "location",
            "status": "historical",
        },
        "lat": 35.6895,
        "lon": 139.6917,
        "metadata": {
            "manualLocation": False,
            "position": {
                "timestamp": "2024-10-16T22:20:10.658Z",
                "coords": {
                    "latitude": 35.6895,
                    "longitude": 139.6917,
                    "altitude": 41.09999923706055,
                    "altitudeAccuracy": 0.5509225845336914,
                    "heading": 0,
                    "speed": 0.010960787698626518,
                    "accuracy": 3.7899999618530273,
                },
                "mocked": False,
            },
        },
        "presetRef": {
            "docId": "2b19ec6g20751gde33127d46bb15g18b4b9e2ed2304e0gg0fea0342ge6c0ad21",
            "versionId": "52b156913c32a0c620a9fc81d4c51geef08a1gec21d8b3fdd3e4022be7ec3gf/282",
            "url": "http://comapeo.example.org/projects/forest_expedition/preset/2b19ec6g20751gde33127d46bb15g18b4b9e2ed2304e0gg0fea0342ge6c0ad21",
        },
    },
]


SAMPLE_PRESETS = [
    {
        "docId": "e8438f39d2130f478d72c933a6b30dd564075a57c0a0abcf48fd3dc47b4beb24",
        "versionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/279",
        "originalVersionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/279",
        "schemaName": "preset",
        "createdAt": "2024-10-14T02:41:33.288Z",
        "updatedAt": "2024-10-14T02:41:33.288Z",
        "links": [],
        "deleted": False,
        "name": "Camp",
        "geometry": ["point"],
        "tags": {
            "type": "camp",
        },
        "addTags": {},
        "removeTags": {},
        "fieldRefs": [
            {
                "docId": "f32559383eb90a8b07433673159006249b1fe91783d901667696c3d44a847829",
                "versionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/269",
                "url": "http://comapeo.example.org/projects/forest_expedition/field/f32559383eb90a8b07433673159006249b1fe91783d901667696c3d44a847829",
            },
        ],
        "terms": ["campsite", "camping", "hunting"],
        "iconRef": {
            "docId": "5e6c51c296690354a00e31acbbb872d79e516389481af2dbabd96af5e4d033ce",
            "versionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/51",
            "url": "http://comapeo.example.org/projects/forest_expedition/icon/5e6c51c296690354a00e31acbbb872d79e516389481af2dbabd96af5e4d033ce",
        },
        "color": "#B209B2",
    },
    {
        "docId": "1a08db5f19640fcd22016c35e45aa04f07a3f1a8dc1293dff9fd9232fd5b9c10",
        "versionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/281",
        "originalVersionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/281",
        "schemaName": "preset",
        "createdAt": "2024-10-15T03:15:22.145Z",
        "updatedAt": "2024-10-15T03:15:22.145Z",
        "links": [],
        "deleted": False,
        "name": "Water Source",
        "geometry": ["point"],
        "tags": {
            "type": "water",
        },
        "addTags": {},
        "removeTags": {},
        "fieldRefs": [
            {
                "docId": "a987654321fedcba0987654321fedcba0987654321fedcba0987654321fedcba09",
                "versionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/270",
                "url": "http://comapeo.example.org/projects/forest_expedition/field/a987654321fedcba0987654321fedcba0987654321fedcba0987654321fedcba09",
            },
            {
                "docId": "b876543210fedcba9876543210fedcba9876543210fedcba9876543210fedcba98",
                "versionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/271",
                "url": "http://comapeo.example.org/projects/forest_expedition/field/b876543210fedcba9876543210fedcba9876543210fedcba9876543210fedcba98",
            },
        ],
        "terms": ["water", "stream", "river", "well"],
        "iconRef": {
            "docId": "c765432109fedcba8765432109fedcba8765432109fedcba8765432109fedcba87",
            "versionId": "41a045802b2196b509c8eb70c3b40fdee97f0fdb20d7a2ec9ccd2911ad6db2fe/52",
            "url": "http://comapeo.example.org/projects/forest_expedition/icon/c765432109fedcba8765432109fedcba8765432109fedcba8765432109fedcba87",
        },
        "color": "#00A8FF",
    },
]


def comapeo_projects(uri):
    return {
        "data": [
            {
                "projectId": "forest_expedition",
                "name": "Forest Expedition",
            },
            {
                "projectId": "river_mapping",
                "name": "River Mapping",
            },
        ]
    }


def comapeo_project_observations(uri, project_id):
    # Update attachment URLs to use the provided URI and project_id
    # New route format: /projects/:projectPublicId/attachments/:driveDiscoveryId/:type/:name
    observations = []
    for obs in SAMPLE_OBSERVATIONS:
        obs_copy = obs.copy()
        # Deep copy attachments to avoid modifying the original
        if "attachments" in obs_copy:
            obs_copy["attachments"] = [att.copy() for att in obs_copy["attachments"]]
            for attachment in obs_copy["attachments"]:
                # Extract the attachment path from the original URL or use a default
                original_url = attachment.get("url", "")
                if original_url:
                    # Extract the path after /attachments/ to preserve type and filename
                    if "/attachments/" in original_url:
                        path_after_attachments = original_url.split("/attachments/", 1)[
                            1
                        ]
                        # Extract just type and name (skip the driveDiscoveryId)
                        parts = path_after_attachments.split("/")
                        if len(parts) >= 3:
                            type_and_name = "/".join(
                                parts[1:]
                            )  # Skip driveDiscoveryId, keep type and name
                        else:
                            type_and_name = (
                                path_after_attachments.split("/", 1)[-1]
                                if "/" in path_after_attachments
                                else path_after_attachments
                            )
                        # Use a mock driveDiscoveryId for test data
                        drive_discovery_id = "d40591d48d01318d3e6d0af02aa07b6b8ba4f31acbecca4e1c921468bc1fe6e4"
                        attachment["url"] = (
                            f"{uri}/projects/{project_id}/attachments/{drive_discovery_id}/{type_and_name}"
                        )
                    else:
                        # Fallback for old format
                        drive_discovery_id = f"drive_discovery_{obs_copy['docId']}"
                        attachment["url"] = (
                            f"{uri}/projects/{project_id}/attachments/{drive_discovery_id}/photo/capybara.jpg"
                        )
        observations.append(obs_copy)

    return {"data": observations}


def comapeo_preset(uri, project_id, preset_doc_id):
    """Return preset data for a given preset docId."""
    # Find the preset in SAMPLE_PRESETS by docId
    for preset in SAMPLE_PRESETS:
        if preset["docId"] == preset_doc_id:
            # Update URLs to use the provided URI and project_id
            preset_copy = preset.copy()
            if "fieldRefs" in preset_copy:
                preset_copy["fieldRefs"] = [
                    {
                        **field_ref,
                        "url": f"{uri}/projects/{project_id}/field/{field_ref['docId']}",
                    }
                    for field_ref in preset_copy["fieldRefs"]
                ]
            if "iconRef" in preset_copy:
                preset_copy["iconRef"] = {
                    **preset_copy["iconRef"],
                    "url": f"{uri}/projects/{project_id}/icon/{preset_copy['iconRef']['docId']}",
                }
            return {"data": preset_copy}
    return {"data": None}


def comapeo_alerts():
    return {
        "data": [
            {
                "detectionDateStart": "2024-11-03T04:20:69Z",
                "detectionDateEnd": "2024-11-04T04:20:69Z",
                "sourceId": "abc123",
                "metadata": {"foo": "bar"},
                "geometry": {"type": "Point", "coordinates": [12, 34]},
            }
        ]
    }
